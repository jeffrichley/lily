# Fail if the PR body does not follow .github/pull_request_template.md.
# Runs on open, edit, sync, reopen, and when a draft is marked ready.
name: PR body template check

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

jobs:
  pr-body-check:
    runs-on: ubuntu-latest
    steps:
      - name: Validate PR body
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = (pr.body || '').replace(/\r\n/g, '\n');
            const isDraft = !!pr.draft;

            const COMMENT_MARKER = '<!-- pr-body-template-check -->';

            function fail(msg) {
              core.setFailed(msg);
            }

            async function postOrUpdateComment(body) {
              const fullBody = body + '\n\n' + COMMENT_MARKER;
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
              });
              const botComment = comments.find(c => c.body && c.body.includes(COMMENT_MARKER));
              if (botComment) {
                await github.rest.issues.updateComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  comment_id: botComment.id,
                  body: fullBody,
                });
              } else {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  body: fullBody,
                });
              }
            }

            function hasHeading(h) {
              const re = new RegExp(`^#{1,6}\\s+${h}\\s*$`, 'im');
              return re.test(body);
            }

            const requiredHeadings = [
              'Summary',
              'Verification',
              'Risk Assessment',
              'Checklist \\(Ruthless\\)',
            ];
            const missingHeadings = requiredHeadings.filter(h => !hasHeading(h));
            if (missingHeadings.length) {
              const display = missingHeadings.map(h => h.replace(/\\/g, ''));
              const checklist = display.map(h => `- [ ] Add section: **${h}**`).join('\n');
              await postOrUpdateComment(
                '## PR body template check — missing sections\n\n' +
                'Add these required sections to the PR description (see `.github/pull_request_template.md`):\n\n' +
                checklist
              );
              fail(
                'PR body is missing required sections: ' + display.join(', ') +
                '\n\nFix: edit the PR description and add the missing headings from .github/pull_request_template.md'
              );
              return;
            }

            function sectionText(heading) {
              const re = new RegExp(
                `(^#{1,6}\\s+${heading}\\s*$)([\\s\\S]*?)(?=^#{1,6}\\s+|$)`,
                'im'
              );
              const m = body.match(re);
              return m ? m[2].trim() : '';
            }

            function countCheckedInSection(heading) {
              const t = sectionText(heading);
              const matches = t.match(/^\s*-\s*\[x\]\s+/gim);
              return matches ? matches.length : 0;
            }

            const problems = [];

            // Require at least one checkbox checked in each "answered" section
            const riskChecked = countCheckedInSection('Risk Level');
            const perfChecked = countCheckedInSection('Perf Impact');
            const breakingChecked = countCheckedInSection('Breaking Change\\?');
            const schemaChecked = countCheckedInSection('Config / Schema Changes');

            if (riskChecked < 1) problems.push('Risk Level: check one of Low / Medium / High.');
            if (perfChecked < 1) problems.push('Perf Impact: check at least one option.');
            if (breakingChecked < 1) problems.push('Breaking Change?: check Yes or No.');
            if (schemaChecked < 1) problems.push('Config / Schema Changes: check None or Yes.');

            // Verification: must mention gates; non-draft must have them checked
            const verification = sectionText('Verification');
            const hasCleanup = /\/cleanup/.test(verification);
            const hasCoverage = /\/coverage/.test(verification);
            if (!hasCleanup) problems.push('Verification must mention /cleanup (quality + tests).');
            if (!hasCoverage) problems.push('Verification must mention /coverage (coverage threshold).');
            if (!isDraft) {
              const cleanupChecked = /-\s*\[x\][^\n]*\/cleanup/i.test(verification);
              const coverageChecked = /-\s*\[x\][^\n]*\/coverage/i.test(verification);
              if (!cleanupChecked) problems.push('Non-draft PRs: check the /cleanup gate in Required Gates.');
              if (!coverageChecked) problems.push('Non-draft PRs: check the /coverage gate in Required Gates.');
            }

            // Minimal content: Summary not empty, Tests and Failure Modes answered
            const summaryRaw = sectionText('Summary').replace(/<!--[\s\S]*?-->/g, '').replace(/\s/g, '');
            if (summaryRaw.length < 20) {
              problems.push('Summary: add 1–3 sentences (not just placeholders).');
            }

            const testsSection = sectionText('Tests Added / Updated');
            const hasTestBullets = /^\s*-\s+.+/m.test(testsSection);
            const hasNone = /\bnone\b/i.test(testsSection);
            if (!hasTestBullets && !hasNone) {
              problems.push('Tests Added / Updated: list tests or write "None" explicitly.');
            }

            const failureModes = sectionText('Failure Modes Considered');
            const hasFailureBullets = /^\s*-\s+.+/m.test(failureModes);
            const hasNA = /\b(n\/a|n\.a\.|none)\b/i.test(failureModes);
            if (!hasFailureBullets && !hasNA) {
              problems.push('Failure Modes Considered: add at least one bullet or write N/A.');
            }

            if (problems.length) {
              const checklist = problems.map(p => `- [ ] ${p}`).join('\n');
              await postOrUpdateComment(
                '## PR body template check — action needed\n\n' +
                'Update the PR description to fix:\n\n' +
                checklist +
                '\n\nSee `.github/pull_request_template.md` and [CONTRIBUTING.md](https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/blob/HEAD/CONTRIBUTING.md) for how to comply.'
              );
              fail(
                'PR body check failed:\n- ' + problems.join('\n- ') +
                '\n\nUpdate the PR description using .github/pull_request_template.md.'
              );
            }
