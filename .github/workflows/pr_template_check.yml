# Fail if the PR body does not follow .github/pull_request_template.md.
# Runs on open, edit, sync, reopen, and when a draft is marked ready.
name: PR body template check

on:
  pull_request:
    types: [opened, edited, synchronize, reopened, ready_for_review]

jobs:
  pr-body-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: write
    steps:
      - name: Validate PR body
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = (pr.body || '')
              .replace(/^\uFEFF/, '')
              .replace(/\r\n/g, '\n')
              .replace(/\r/g, '\n');

            function escapeHeading(h) {
              return h.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            }
            function hasHeading(h) {
              const re = new RegExp(`^#{1,6}\\s+${escapeHeading(h)}\\s*$`, 'im');
              return re.test(body);
            }

            const requiredHeadings = [
              'Summary',
              'Verification',
              'Risk Assessment',
              'Checklist (Ruthless)',
            ];
            const missingHeadings = requiredHeadings.filter(h => !hasHeading(h));
            if (missingHeadings.length) {
              const checklist = missingHeadings.map(h => `- [ ] Add section: **${h}**`).join('\n');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: '## PR body template check â€” missing sections\n\n' +
                  'Add these required sections to the PR description (see `.github/pull_request_template.md`):\n\n' +
                  checklist,
              });
              core.setFailed(
                'PR body is missing required sections: ' + missingHeadings.join(', ')
              );
            }
